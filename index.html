<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TERMINAL RVI: OTP_SYNC</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        
        /* UI TERMINAL */
        .terminal-box { width: 100%; max-width: 400px; border: 1px solid #0f0; padding: 20px; background: rgba(0,10,0,0.9); box-shadow: 0 0 20px rgba(0,255,0,0.2); position: relative; }
        .header { border-bottom: 2px solid #0f0; margin-bottom: 20px; text-align: center; padding-bottom: 10px; }
        
        /* INPUT & BUTTON */
        .input-group { display: flex; flex-direction: column; gap: 15px; }
        input { background: transparent; border: 1px solid #0f0; color: #0f0; padding: 12px; text-align: center; outline: none; font-size: 1.1em; }
        button { background: #0f0; color: #000; border: none; padding: 12px; font-weight: 800; cursor: pointer; text-transform: uppercase; }
        button:disabled { background: #050; color: #000; cursor: not-allowed; }

        /* SCREENS */
        #otp-screen, #main-terminal { display: none; }
        
        /* STATS UI */
        .profile-card { text-align: center; display: none; }
        .pfp { width: 110px; height: 110px; border: 1px solid #0f0; margin: 15px auto; clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%); }
        .stat-row { display: flex; justify-content: space-between; border: 1px solid rgba(0,255,0,0.3); padding: 8px; margin-bottom: 5px; font-size: 0.8em; }
        
        .loading-text { font-size: 0.7em; margin: 10px 0; display: none; color: #888; }
        .scan { position: absolute; top:0; left:0; width:100%; height:2px; background:rgba(0,255,0,0.3); animation: scan 3s infinite linear; }
        @keyframes scan { 0% {top:0} 100% {top:100%} }
    </style>
</head>
<body>

<div class="terminal-box">
    <div class="scan"></div>
    <div class="header">
        <h2 style="margin:0; font-size: 1em;">BKI_DATA_EXTRACTOR</h2>
        <small style="font-size: 0.6em;">ENCRYPTED VIA RMAIL_OTP</small>
    </div>

    <div id="login-screen" class="input-group">
        <p style="font-size: 0.7em; text-align: center;">ENTER RMAIL USERNAME TO RECEIVE CODE</p>
        <input type="text" id="target-user" placeholder="USERNAME">
        <button onclick="requestOTP()">GENERATE_OTP</button>
        <p id="err-1" style="color:red; font-size:0.6em; text-align:center"></p>
    </div>

    <div id="otp-screen" class="input-group">
        <p style="font-size: 0.7em; text-align: center; color: yellow;">[!] CHECK RMAIL APP FROM 'VerifyOTP'</p>
        <input type="number" id="otp-input" placeholder="6-DIGIT CODE">
        <button onclick="verifyOTP()">VERIFY_ACCESS</button>
        <button onclick="location.reload()" style="background:transparent; color:#0f0; border:1px solid #0f0; font-size:0.6em; padding:5px">BACK</button>
    </div>

    <div id="main-terminal">
        <div class="input-group">
            <input type="text" id="tk-user" placeholder="TIKTOK_USERNAME">
            <button onclick="extractTikTok()">EXTRACT_DATA</button>
        </div>
        <div id="loading" class="loading-text">CONNECTING...<br>BYPASSING SSL...</div>
        <div id="result" class="profile-card">
            <img id="pfp" class="pfp">
            <h4 id="nick" style="margin:0"></h4>
            <div id="stats" style="margin-top:15px"></div>
            <button onclick="doLogout()" style="width:100%; margin-top:20px; font-size:0.7em; background:red; color:white">EXIT_SYSTEM</button>
        </div>
    </div>
</div>

<script>
// -- BKI DATABASE SYNC --
const config = { databaseURL: "https://rmail-68719-default-rtdb.asia-southeast1.firebasedatabase.app" };
firebase.initializeApp(config);
const db = firebase.database();

let currentUser = "";

// Cek Sesi LocalStorage
window.onload = () => {
    if(localStorage.getItem("miner_auth") === "granted") {
        showScreen('main-terminal');
    }
}

async function requestOTP() {
    const user = document.getElementById('target-user').value.trim().toLowerCase();
    if(!user) return;
    
    document.getElementById('err-1').innerText = "[SYS]: CHECKING DATABASE...";
    
    db.ref('users/' + user).once('value', async (s) => {
        if(s.exists()) {
            currentUser = user;
            const otp = Math.floor(100000 + Math.random() * 900000); // Generate 6 Digit
            
            // 1. Simpan OTP ke Database User
            await db.ref('users/' + user + '/otp').set(otp);
            
            // 2. Kirim Pesan via VerifyOTP (Centang Biru Otomatis dari RAI logik)
            const rid = ["verifyotp", user].sort().join("_");
            await db.ref('chats/' + rid).push({
                s: "VerifyOTP",
                t: "KODE OTP PORTAL BKI ANDA: " + otp + ". Jangan sebarkan kode ini!",
                time: Date.now()
            });
            
            // Update List Chat User agar muncul di atas
            await db.ref('mylists/' + user + '/verifyotp').update({ isG: false, last: Date.now() });

            showScreen('otp-screen');
        } else {
            document.getElementById('err-1').innerText = "[ERR]: USER NOT FOUND";
        }
    });
}

function verifyOTP() {
    const input = document.getElementById('otp-input').value;
    db.ref('users/' + currentUser + '/otp').once('value', (s) => {
        if(s.val() == input) {
            localStorage.setItem("miner_auth", "granted");
            localStorage.setItem("miner_user", currentUser);
            showScreen('main-terminal');
        } else {
            alert("KODE OTP SALAH!");
        }
    });
}

async function extractTikTok() {
    const target = document.getElementById('tk-user').value;
    if(!target) return;
    const loader = document.getElementById('loading');
    const resDiv = document.getElementById('result');
    
    loader.style.display = 'block';
    resDiv.style.display = 'none';

    try {
        const res = await fetch(`https://www.tikwm.com/api/user/info?unique_id=${target}`);
        const json = await res.json();
        if(json.code === 0) {
            const d = json.data;
            document.getElementById('pfp').src = d.user.avatarMedium;
            document.getElementById('nick').innerText = d.user.nickname;
            document.getElementById('stats').innerHTML = `
                <div class="stat-row"><span>FOLLOWERS</span><span>${d.stats.followerCount.toLocaleString()}</span></div>
                <div class="stat-row"><span>LIKES</span><span>${d.stats.heartCount.toLocaleString()}</span></div>
                <div class="stat-row"><span>VIDEOS</span><span>${d.stats.videoCount}</span></div>
            `;
            loader.style.display = 'none';
            resDiv.style.display = 'block';
        } else { alert("TARGET NOT FOUND"); loader.style.display='none'; }
    } catch (e) { alert("API ERROR"); loader.style.display='none'; }
}

function showScreen(id) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('otp-screen').style.display = 'none';
    document.getElementById('main-terminal').style.display = 'none';
    document.getElementById(id).style.display = 'block';
}

function doLogout() {
    localStorage.clear();
    location.reload();
}
</script>
</body>
</html>
