<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RLOY v2 | Member Console</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --b-black: #000; --accent-red: #fe2c55; }
        body { background: var(--b-black); color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; margin:0; overflow-x: hidden; }
        .hidden { display: none !important; }
        .glass-box { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(20px); border-radius: 30px; padding: 35px; }
        .btn-premium { background: #fff; color: #000; padding: 18px 32px; border-radius: 18px; font-weight: 800; transition: 0.4s; cursor: pointer; border: none; }
        .btn-premium:hover { background: var(--accent-red); color: #fff; transform: scale(1.02); }
        .input-premium { background: #080808; border: 1px solid #1a1a1a; padding: 20px; border-radius: 18px; width: 100%; color: #fff; outline: none; margin-bottom: 12px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #222; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00ff88; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

<div id="main-app">
    <nav class="fixed top-0 w-full z-[100] bg-black/50 backdrop-blur-xl px-6 py-5 flex justify-between items-center border-b border-white/5">
        <h1 class="text-3xl font-black italic tracking-tighter cursor-pointer" onclick="location.reload()">RLOY</h1>
        <div class="text-[9px] font-bold text-gray-600 uppercase tracking-[0.3em]">PT Bangga Karya Indonesia</div>
    </nav>

    <section id="p-gate" class="hidden min-h-screen flex items-center justify-center px-6">
        <div class="w-full max-w-sm glass-box text-center">
            <h2 class="text-2xl font-black italic mb-8 uppercase tracking-widest">Akses Console</h2>
            <input type="text" id="user-id" placeholder="USERNAME" class="input-premium text-center uppercase font-bold">
            <input type="password" id="user-pw" placeholder="PASSWORD" class="input-premium text-center font-bold">
            <button onclick="handleAuth()" class="w-full btn-premium mb-4">MASUK / DAFTAR</button>
            <br>
            <a href="https://wa.me/62882008519349" target="_blank" class="text-[10px] text-gray-500 hover:text-white transition uppercase font-bold tracking-widest">Lupa Password? Chat Admin</a>
        </div>
    </section>

    <section id="p-console" class="hidden min-h-screen pt-32 px-6 pb-20">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-end mb-16">
                <div>
                    <h2 class="text-5xl font-black italic tracking-tighter mb-2">My Console</h2>
                    <p class="text-red-500 font-bold text-xs uppercase" id="display-name"></p>
                </div>
                <button onclick="logout()" class="text-[9px] font-black text-gray-500 uppercase border border-white/10 px-4 py-2 rounded-lg hover:bg-red-600 hover:text-white transition">Logout</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                <div class="lg:col-span-5">
                    <div class="glass-box">
                        <input type="text" id="web-slug" class="input-premium" placeholder="nama-slug-website">
                        <div class="border-2 border-dashed border-white/5 p-16 rounded-3xl relative text-center mb-6 group hover:border-white transition cursor-pointer">
                            <input type="file" id="web-file" accept=".html" class="absolute inset-0 opacity-0 cursor-pointer" onchange="readFile(this)">
                            <p id="file-label" class="text-[10px] font-black text-gray-500 uppercase">Upload index.html</p>
                        </div>
                        <button onclick="pushDeploy()" class="w-full btn-premium">PUBLISH</button>
                    </div>
                </div>
                <div class="lg:col-span-7"><div id="project-list" class="grid grid-cols-1 gap-6"></div></div>
            </div>
        </div>
    </section>
</div>

<div id="render-engine" class="hidden"></div>

<script>
    const fb = { databaseURL: "https://rmail-68719-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(fb);
    const db = firebase.database();

    let htmlBuffer = "";
    let currentOwner = localStorage.getItem('rloy_session_user') || "";

    function handleRouting() {
        const hash = window.location.hash.substring(1);
        const app = document.getElementById('main-app');
        const engine = document.getElementById('render-engine');

        if (hash && !['console', 'gate'].includes(hash)) {
            app.classList.add('hidden');
            engine.classList.remove('hidden');
            db.ref('sites/' + hash).on('value', s => {
                if (s.exists()) {
                    const d = s.val();
                    if (d.status === "banned") {
                        engine.innerHTML = `<div style="background:#000; color:#fff; height:100vh; width:100vw; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; font-family:sans-serif;"><h1>WEBSITE DIBLOKIR</h1><p>Melanggar peraturan RLOY / PT BKI.</p></div>`;
                    } else if (d.status === "off") {
                        engine.innerHTML = `<div style="background:#000; color:#fff; height:100vh; width:100vw; display:flex; align-items:center; justify-content:center;"><h1>MAINTENANCE</h1></div>`;
                    } else {
                        document.open(); document.write(d.content); document.close();
                    }
                }
            });
        } else {
            app.classList.remove('hidden');
            engine.classList.add('hidden');
            if (!currentOwner) showPage('gate');
            else {
                document.getElementById('display-name').innerText = "USER: " + currentOwner.toUpperCase();
                showPage('console');
                loadProjects();
            }
        }
    }

    function showPage(id) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.getElementById('p-' + id).classList.remove('hidden');
    }

    function handleAuth() {
        const id = document.getElementById('user-id').value.trim().toLowerCase();
        const pw = document.getElementById('user-pw').value.trim();
        if (!id || !pw) return alert("Lengkapi data!");
        db.ref('users_rloy/' + id).once('value', s => {
            if (s.exists()) {
                if (s.val().pw === pw) { loginSuccess(id); } else { alert("Password salah!"); }
            } else {
                if (confirm("Daftar user baru?")) {
                    db.ref('users_rloy/' + id).set({ pw: pw, created: new Date().toLocaleString() }).then(() => loginSuccess(id));
                }
            }
        });
    }

    function loginSuccess(id) { localStorage.setItem('rloy_session_user', id); currentOwner = id; handleRouting(); }
    function logout() { localStorage.removeItem('rloy_session_user'); location.reload(); }

    function readFile(input) {
        const reader = new FileReader();
        reader.onload = (e) => { htmlBuffer = e.target.result; document.getElementById('file-label').innerText = "READY"; };
        reader.readAsText(input.files[0]);
    }

    function pushDeploy() {
        const slug = document.getElementById('web-slug').value.trim().toLowerCase().replace(/\s+/g, '-');
        if (!slug || !htmlBuffer) return alert("Error!");
        db.ref('sites/' + slug).set({ content: htmlBuffer, owner: currentOwner, time: new Date().toLocaleString(), status: "on" })
        .then(() => { alert("Live!"); loadProjects(); });
    }

    function loadProjects() {
        const list = document.getElementById('project-list');
        db.ref('sites').orderByChild('owner').equalTo(currentOwner).on('value', s => {
            list.innerHTML = "";
            s.forEach(child => {
                const d = child.val();
                list.innerHTML += `<div class="glass-box !p-6 flex justify-between items-center">
                    <div><h4 class="font-bold italic">/${child.key}</h4></div>
                    <div class="flex items-center gap-4">
                        <label class="switch"><input type="checkbox" ${d.status === 'on' ? 'checked' : ''} onchange="toggleStatus('${child.key}','${d.status}')"><span class="slider"></span></label>
                        <a href="#${child.key}" class="text-[9px] font-bold border border-white/10 px-3 py-2 rounded">OPEN</a>
                    </div>
                </div>`;
            });
        });
    }

    function toggleStatus(slug, current) {
        if(current === 'banned') return alert("Diblokir Admin!");
        db.ref('sites/' + slug).child('status').set(current === 'on' ? 'off' : 'on');
    }

    window.onload = handleRouting;
    window.onhashchange = handleRouting;
</script>
</body>
</html>
